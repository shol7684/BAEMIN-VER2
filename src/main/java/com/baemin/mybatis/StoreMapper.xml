<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="store">

	<select id="storeList" resultType="store">
SELECT * FROM     
	( SELECT rownum rn, s.*,t.* FROM 
		BM_STORE s
	        LEFT JOIN    
				( SELECT r.store_id, r.score, r.review_count, r.boss_comment_count, c.order_count FROM  
					( SELECT store_id, AVG(score) SCORE, count(review_content) review_count, count(boss_comment) boss_comment_count FROM bm_review GROUP BY store_id ) r ,
					( SELECT store_id, SUM(order_count) order_count from (
						SELECT store_id, count(*) order_count FROM bm_order_detail_user GROUP BY store_id
							UNION ALL
						SELECT store_id, count(*) order_count FROM bm_order_detail_non_user GROUP BY store_id ) GROUP BY store_id ) c 
				) t
			ON s.id = t.store_id     
			WHERE CATEGORY = #{category} AND STORE_ADDRESS1 LIKE '${address1}%' )
	WHERE rn BETWEEN ${startPage } AND ${endPage }		
	</select>

	<select id="storeDetail" resultType="Store">
		SELECT * FROM 
			BM_STORE,
			( SELECT * FROM  
				( SELECT AVG(score) SCORE, count(review_content) review_count, count(boss_comment) boss_comment_count FROM bm_review WHERE store_id = #{id } ),
				( SELECT SUM(order_count) order_count from (
					SELECT count(*) order_count FROM bm_order_detail_user WHERE store_id = #{id }
						UNION ALL
					SELECT count(*) order_count FROM bm_order_detail_non_user WHERE store_id = #{id } ) )
			) 
		WHERE ID = #{id }
	</select>
	
	<select id="foodList" resultType="Food">
		SELECT
		    id,
		    store_id,
		    food_name,
		    food_price,
		    food_dec,
		    food_img,
		    food_thumb
		FROM
		    bm_food
		WHERE
			STORE_ID = #{id }    
	</select>
	
	<select id="foodOption" resultType="FoodOption">
		SELECT
		    id,
		    food_id,
		    option_name,
		    option_price
		FROM
		    bm_food_option
		WHERE
			food_id = #{foodId }    
	</select>
	
	
	
	<insert id="reviewWrite">
		INSERT INTO BM_REVIEW (
		    ORDER_NUM
		    ,STORE_ID
		    ,REVIEW_CONTENT
		    ,USER_ID
		    ,SCORE
		    ,REVIEW_IMG 
		) VALUES (
			${orderNum }
			,#{storeId }
			,#{reviewContent }
			,#{userId}
			,#{score}
			,#{reviewImg }
		)		
	</insert>

	<update id="reviewModify">
		UPDATE BM_REVIEW SET
		    REVIEW_CONTENT = #{reviewContent }
		    ,SCORE = #{score}
		    ,REVIEW_IMG = #{reviewImg }
		WHERE
			ORDER_NUM = ${orderNum }    
	</update>

	<select id="reviewList" resultType="Review">
		SELECT
		    r.order_num,
		    r.store_id,
		    r.review_content,
		    r.boss_comment,
		    r.regi_date,
		    r.score,
		    r.review_img,
		    r.user_id,
		    u.nickname
		FROM
		    bm_review r
		LEFT JOIN
		    bm_user u
		ON
		    r.user_id = u.id
		WHERE
		    r.store_id = #{id}
	</select>


</mapper>
